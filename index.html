<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>食券発行システム</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- QRコード生成ライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  padding: 20px;
}
button {
  font-size: 18px;
  padding: 10px 20px;
}
button:disabled {
  opacity: 0.5;
}
#qr canvas {
  margin-top: 20px;
}
#msg {
  margin-top: 15px;
  font-size: 16px;
}
</style>
</head>
<body>

<h2>無料食券 発行ページ</h2>
<p>本日の発行枚数：<span id="count">--</span> 枚</p>

<button id="issueBtn">食券を発行</button>
<p id="msg"></p>

<div id="qr"></div>

<script type="module">
/* ===============================
   共通ユーティリティ（JST）
================================ */
function getTodayJST() {
  const now = new Date();
  const jst = new Date(now.getTime() + 9 * 60 * 60 * 1000);
  return jst.toISOString().slice(0, 10);
}

/* ===============================
   localStorage 自動掃除
   issued-* / ticket-* のみ対象
================================ */
function cleanupLocalStorage(today) {
  for (let i = localStorage.length - 1; i >= 0; i--) {
    const key = localStorage.key(i);
    if (
      key &&
      (key.startsWith("issued-") || key.startsWith("ticket-")) &&
      !key.endsWith(today)
    ) {
      localStorage.removeItem(key);
    }
  }
}

/* Firebase SDK */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase 設定 */
const firebaseConfig = {
  apiKey: "AIzaSyALuZuT-PUJ8EGVQ0FfzZvN0c2lMujjqxw",
  authDomain: "ticket-system-acabc.firebaseapp.com",
  projectId: "ticket-system-acabc",
  storageBucket: "ticket-system-acabc.firebasestorage.app",
  messagingSenderId: "738817015202",
  appId: "1:738817015202:web:aa5c5b10c55f1069cec6fb"
};

/* 初期化 */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===============================
   日付・初期処理
================================ */
const today = getTodayJST();
cleanupLocalStorage(today);

const colRef = collection(db, "tickets-" + today);

/* ===============================
   DOM
================================ */
const issueBtn = document.getElementById("issueBtn");
const msg = document.getElementById("msg");
const qrDiv = document.getElementById("qr");

/* ===============================
   1日1回制限 + QR復元
================================ */
const issuedKey = "issued-" + today;
const ticketKey = "ticket-" + today;

/* すでに発行済みの場合（QR復元） */
const savedTicketId = localStorage.getItem(ticketKey);
if (savedTicketId) {
  issueBtn.disabled = true;
  msg.textContent = "本日の食券は発行済みです（QRを再表示しています）";
  restoreQR(savedTicketId);
} else if (localStorage.getItem(issuedKey)) {
  issueBtn.disabled = true;
  msg.textContent = "本日はすでに食券を発行しています。";
}

/* ===============================
   発行枚数表示
================================ */
async function updateCount() {
  const snapshot = await getDocs(colRef);
  document.getElementById("count").textContent = snapshot.size;
}
updateCount();

/* ===============================
   QR表示・復元
================================ */
function restoreQR(ticketId) {
  qrDiv.innerHTML = "";
  QRCode.toCanvas(ticketId, { width: 250 }, (err, canvas) => {
    if (err) {
      msg.textContent = "QR復元エラー";
      return;
    }
    qrDiv.appendChild(canvas);
  });
}

/* ===============================
   発行処理
================================ */
issueBtn.addEventListener("click", async () => {
  try {
    issueBtn.disabled = true;

    const docRef = await addDoc(colRef, {
      used: false,
      created: serverTimestamp()
    });

    const ticketId = docRef.id;

    // localStorage に保存（核心）
    localStorage.setItem(issuedKey, "true");
    localStorage.setItem(ticketKey, ticketId);

    restoreQR(ticketId);

    msg.textContent = "本日の食券を発行しました。";
    updateCount();

  } catch (e) {
    alert("発行エラー：" + e.message);
    console.error(e);
    issueBtn.disabled = false;
  }
});
</script>

</body>
</html>
