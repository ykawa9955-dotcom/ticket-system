<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>食券発行システム</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body { font-family: sans-serif; padding:20px; }
#qr canvas { margin-top:20px; }
button { padding:10px 20px; font-size:18px; }
</style>
</head>
<body>

<h2>無料食券 発行ページ</h2>
<p>発行枚数：<span id="count">--</span> 枚</p>
<button id="issueBtn">食券を発行</button>

<div id="qr"></div>

<script>
// ▼ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyALuZuT-PUJ8EGVQ0FfzZvN0c2lMujjqxw",
  authDomain: "ticket-system-acabc.firebaseapp.com",
  projectId: "ticket-system-acabc",
  storageBucket: "ticket-system-acabc.firebasestorage.app",
  messagingSenderId: "738817015202",
  appId: "1:738817015202:web:aa5c5b10c55f1069cec6fb"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ▼ 今日の日付
const today = new Date().toISOString().slice(0, 10);

// ▼ 発行数の表示
function updateCount() {
    db.collection("tickets-" + today)
      .get()
      .then(s => document.getElementById("count").textContent = s.size);
}
updateCount();

// ▼ 食券発行ボタン
document.getElementById("issueBtn").onclick = async () => {

    // Firestore に未使用券を保存
    const ref = await db.collection("tickets-" + today).add({
        used: false,
        created: new Date(),
    });

    const ticketId = ref.id;

    // QR コード表示（ticketId を埋め込む）
    document.getElementById("qr").innerHTML = "";
    QRCode.toCanvas(ticketId, { width: 250 }, (err, canvas) => {
        document.getElementById("qr").appendChild(canvas);
    });

    updateCount();
};
</script>

</body>
</html>
