<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>食券カウントシステム</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: system-ui, sans-serif; padding: 20px; }
#reader { width: 300px; margin-top: 20px; }
#msg { margin-top: 20px; font-size: 18px; }
#nextBtn {
  margin-top: 20px;
  padding: 12px 20px;
  font-size: 18px;
  display: none;
}
</style>
</head>
<body>

<h2>食券カウント</h2>
<p>本日の使用済み：<span id="count">--</span> 枚</p>

<div id="reader"></div>
<p id="msg"></p>

<button id="nextBtn">次のQRを読み込む</button>

<script type="module">
/* ===============================
   共通ユーティリティ（JST）
================================ */
function getTodayJST() {
  const now = new Date();
  return (
    now.getFullYear() + "-" +
    String(now.getMonth() + 1).padStart(2, "0") + "-" +
    String(now.getDate()).padStart(2, "0")
  );
}

/* ===============================
   localStorage 自動掃除
   （将来拡張・安全対策）
================================ */
function cleanupLocalStorage(today) {
  for (let i = localStorage.length - 1; i >= 0; i--) {
    const key = localStorage.key(i);
    if (key && key.startsWith("issued-") && !key.endsWith(today)) {
      localStorage.removeItem(key);
    }
  }
}

/* Firebase SDK */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  doc,
  getDoc,
  updateDoc,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase 設定 */
const firebaseConfig = {
  apiKey: "AIzaSyALuZuT-PUJ8EGVQ0FfzZvN0c2lMujjqxw",
  authDomain: "ticket-system-acabc.firebaseapp.com",
  projectId: "ticket-system-acabc",
  storageBucket: "ticket-system-acabc.firebasestorage.app",
  messagingSenderId: "738817015202",
  appId: "1:738817015202:web:aa5c5b10c55f1069cec6fb"
};

/* 初期化 */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===============================
   日付・コレクション（JST）
================================ */
const today = getTodayJST();
cleanupLocalStorage(today);

const colRef = collection(db, "tickets-" + today);

/* ===============================
   使用済み枚数
================================ */
async function updateCount() {
  const q = query(colRef, where("used", "==", true));
  const snap = await getDocs(q);
  document.getElementById("count").textContent = snap.size;
}
updateCount();

/* ===============================
   QRリーダー制御
================================ */
const html5QrCode = new Html5Qrcode("reader");
let locked = false;
let lastCode = null;

async function startScanner() {
  locked = false;
  lastCode = null;
  document.getElementById("msg").textContent = "";
  document.getElementById("nextBtn").style.display = "none";

  await html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScanSuccess
  );
}

/* QR読み取り成功時 */
async function onScanSuccess(decodedText) {
  if (locked || decodedText === lastCode) return;

  locked = true;
  lastCode = decodedText;

  // 先にカメラ停止（多重発火防止）
  try { await html5QrCode.stop(); } catch {}

  const msg = document.getElementById("msg");
  const ref = doc(colRef, decodedText);

  try {
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      msg.textContent = "❌ 無効なQRコードです";
    } else if (snap.data().used) {
      msg.textContent = "⚠️ すでに使用済みです";
    } else {
      await updateDoc(ref, { used: true });
      msg.textContent = "✅ 有効 → 使用済みにしました";
      updateCount();
    }

  } catch (e) {
    msg.textContent = "エラー：" + e.message;
    console.error(e);
  }

  // 次のQR読み込みボタン表示
  document.getElementById("nextBtn").style.display = "inline-block";
}

/* 次のQRボタン */
document.getElementById("nextBtn").addEventListener("click", () => {
  startScanner();
});

/* 初回起動 */
startScanner();
</script>

</body>
</html>
