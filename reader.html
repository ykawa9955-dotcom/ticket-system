<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>食券カウントシステム</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: system-ui, sans-serif; padding: 20px; }
#reader { width: 300px; margin-top: 20px; }
#msg { margin-top: 20px; font-size: 18px; }
#nextBtn {
  margin-top: 20px;
  padding: 12px 20px;
  font-size: 18px;
  display: none;
}
</style>
</head>
<body>

<h2>食券カウント</h2>
<p>本日の使用済み：<span id="count">--</span> 枚</p>

<div id="reader"></div>
<p id="msg"></p>

<button id="nextBtn">次のQRを読み込む</button>

<script type="module">
/* ===============================
   共通ユーティリティ（JST）
================================ */
function getTodayJST() {
  const now = new Date();
  return (
    now.getFullYear() + "-" +
    String(now.getMonth() + 1).padStart(2, "0") + "-" +
    String(now.getDate()).padStart(2, "0")
  );
}

/* ===============================
   読み取り音（音分岐対応）
================================ */
function playBeep(type = "ok") {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();

  let freq = 1000;
  let times = 1;

  if (type === "ok") {
    freq = 1200; // 有効：高音1回
    times = 1;
  } else if (type === "used") {
    freq = 400;  // 使用済み：低音2回
    times = 2;
  } else {
    freq = 200;  // 無効：低音1回
    times = 1;
  }

  let count = 0;

  function beepOnce() {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.type = "sine";
    osc.frequency.value = freq;
    gain.gain.value = 0.2;

    osc.connect(gain);
    gain.connect(ctx.destination);

    osc.start();
    setTimeout(() => {
      osc.stop();
      count++;
      if (count < times) {
        setTimeout(beepOnce, 130); // ピッ・ピッの間隔
      } else {
        ctx.close();
      }
    }, 130);
  }

  beepOnce();
}

/* Firebase SDK */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  doc,
  getDoc,
  updateDoc,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase 設定 */
const firebaseConfig = {
  apiKey: "AIzaSyALuZuT-PUJ8EGVQ0FfzZvN0c2lMujjqxw",
  authDomain: "ticket-system-acabc.firebaseapp.com",
  projectId: "ticket-system-acabc",
  storageBucket: "ticket-system-acabc.firebasestorage.app",
  messagingSenderId: "738817015202",
  appId: "1:738817015202:web:aa5c5b10c55f1069cec6fb"
};

/* 初期化 */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===============================
   日付・コレクション（JST）
================================ */
const today = getTodayJST();
const colRef = collection(db, "tickets-" + today);

/* ===============================
   使用済み枚数
================================ */
async function updateCount() {
  const q = query(colRef, where("used", "==", true));
  const snap = await getDocs(q);
  document.getElementById("count").textContent = snap.size;
}
updateCount();

/* ===============================
   QRリーダー制御
================================ */
const html5QrCode = new Html5Qrcode("reader");
let locked = false;
let lastCode = null;

async function startScanner() {
  locked = false;
  lastCode = null;
  document.getElementById("msg").textContent = "";
  document.getElementById("nextBtn").style.display = "none";

  await html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScanSuccess
  );
}

/* QR読み取り成功時 */
async function onScanSuccess(decodedText) {
  if (locked || decodedText === lastCode) return;

  locked = true;
  lastCode = decodedText;

  // 多重発火防止
  try { await html5QrCode.stop(); } catch {}

  const msg = document.getElementById("msg");
  const ref = doc(colRef, decodedText);

  try {
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      playBeep("ng");
      msg.textContent = "❌ 無効なQRコードです";

    } else if (snap.data().used) {
      playBeep("used"); // ★ ピッ・ピッ（低音）
      msg.textContent = "⚠️ すでに使用済みです";

    } else {
      playBeep("ok");
      await updateDoc(ref, { used: true });
      msg.textContent = "✅ 有効 → 使用済みにしました";
      updateCount();
    }

  } catch (e) {
    msg.textContent = "エラー：" + e.message;
    console.error(e);
  }

  document.getElementById("nextBtn").style.display = "inline-block";
}

/* 次のQR */
document.getElementById("nextBtn").addEventListener("click", () => {
  startScanner();
});

/* 初回起動 */
startScanner();
</script>

</body>
</html>
