<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>é£Ÿåˆ¸ã‚«ã‚¦ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ </title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: system-ui, sans-serif; padding: 20px; }
#reader { width: 300px; margin-top: 20px; }
#msg { margin-top: 20px; font-size: 18px; }
#nextBtn, #startBtn {
  margin-top: 20px;
  padding: 12px 20px;
  font-size: 18px;
}
#nextBtn { display: none; }
</style>
</head>
<body>

<h2>é£Ÿåˆ¸ã‚«ã‚¦ãƒ³ãƒˆ</h2>
<p>æœ¬æ—¥ã®ä½¿ç”¨æ¸ˆã¿ï¼š<span id="count">--</span> æš</p>

<button id="startBtn">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹åŒ–ã—ã¦é–‹å§‹</button>

<div id="reader"></div>
<p id="msg"></p>

<button id="nextBtn">æ¬¡ã®QRã‚’èª­ã¿è¾¼ã‚€</button>

<script type="module">
/* ===============================
   Audioï¼ˆâ€»ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¿…é ˆï¼‰
================================ */
let audioCtx = null;

function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  audioCtx.resume();
}

function playBeep(type = "ok") {
  if (!audioCtx) return;

  let freq = 1000;
  let times = 1;

  if (type === "ok") {
    freq = 1200;       // æœ‰åŠ¹ï¼šé«˜éŸ³1å›
    times = 1;
  } else if (type === "used") {
    freq = 400;        // ä½¿ç”¨æ¸ˆã¿ï¼šä½éŸ³2å›
    times = 2;
  } else {
    freq = 250;        // ç„¡åŠ¹ï¼šä½éŸ³1å›
    times = 1;
  }

  let played = 0;

  function beep() {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.frequency.value = freq;
    gain.gain.value = 0.25;

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start();
    setTimeout(() => {
      osc.stop();
      played++;
      if (played < times) {
        setTimeout(beep, 150);
      }
    }, 150);
  }
  beep();
}

/* ===============================
   æ—¥ä»˜ï¼ˆJSTï¼‰
================================ */
function getTodayJST() {
  const now = new Date();
  return (
    now.getFullYear() + "-" +
    String(now.getMonth() + 1).padStart(2, "0") + "-" +
    String(now.getDate()).padStart(2, "0")
  );
}

/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  doc,
  getDoc,
  updateDoc,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyALuZuT-PUJ8EGVQ0FfzZvN0c2lMujjqxw",
  authDomain: "ticket-system-acabc.firebaseapp.com",
  projectId: "ticket-system-acabc"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const today = getTodayJST();
const colRef = collection(db, "tickets-" + today);

/* ä½¿ç”¨æ¸ˆã¿æ•° */
async function updateCount() {
  const snap = await getDocs(query(colRef, where("used", "==", true)));
  document.getElementById("count").textContent = snap.size;
}
updateCount();

/* QR */
const html5QrCode = new Html5Qrcode("reader");
let locked = false;

async function startScanner() {
  locked = false;
  document.getElementById("msg").textContent = "";
  document.getElementById("nextBtn").style.display = "none";

  await html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScanSuccess
  );
}

async function onScanSuccess(text) {
  if (locked) return;
  locked = true;

  try { await html5QrCode.stop(); } catch {}

  const msg = document.getElementById("msg");
  const ref = doc(colRef, text);

  const snap = await getDoc(ref);

  if (!snap.exists()) {
    playBeep("ng");
    msg.textContent = "âŒ ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™";

  } else if (snap.data().used) {
    playBeep("used"); // â˜… ãƒ”ãƒƒãƒ»ãƒ”ãƒƒï¼ˆä½éŸ³ï¼‰
    msg.textContent = "âš ï¸ ã™ã§ã«ä½¿ç”¨æ¸ˆã¿ã§ã™";

  } else {
    playBeep("ok");
    await updateDoc(ref, { used: true });
    msg.textContent = "âœ… æœ‰åŠ¹ â†’ ä½¿ç”¨æ¸ˆã¿ã«ã—ã¾ã—ãŸ";
    updateCount();
  }

  document.getElementById("nextBtn").style.display = "inline-block";
}

/* ãƒœã‚¿ãƒ³ */
document.getElementById("startBtn").addEventListener("click", async () => {
  initAudio();
  document.getElementById("startBtn").style.display = "none";
  startScanner();
});

document.getElementById("nextBtn").addEventListener("click", startScanner);
</script>

</body>
</html>
