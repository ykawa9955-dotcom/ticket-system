<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  padding: 20px;
  background: #f5f5f5;
}
h1 {
  margin-bottom: 10px;
}
.card {
  background: #fff;
  padding: 20px;
  margin-top: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.count {
  font-size: 32px;
  font-weight: bold;
}
.label {
  color: #666;
}
input[type="date"] {
  font-size: 16px;
  padding: 6px;
}
button {
  font-size: 16px;
  padding: 6px 12px;
  margin-top: 8px;
}
#qr canvas {
  margin-top: 15px;
}
#msg {
  margin-top: 10px;
}
.sub {
  font-size: 14px;
  color: #888;
}
</style>
</head>
<body>

<h1>ğŸ“Š ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

<p>
  æ—¥ä»˜ï¼š
  <input type="date" id="datePicker">
  <button id="loadBtn">è¡¨ç¤º</button>
</p>

<!-- å…¨ä½“ -->
<div class="card">
  <div class="label">ç™ºè¡Œæšæ•°ï¼ˆåˆè¨ˆï¼‰</div>
  <div class="count" id="issued">--</div>
</div>

<div class="card">
  <div class="label">ä½¿ç”¨æ¸ˆã¿ï¼ˆåˆè¨ˆï¼‰</div>
  <div class="count" id="used">--</div>
</div>

<div class="card">
  <div class="label">æœªä½¿ç”¨ï¼ˆåˆè¨ˆï¼‰</div>
  <div class="count" id="unused">--</div>
</div>

<!-- ç®¡ç†è€…ç™ºè¡Œ -->
<div class="card">
  <div class="label">ğŸ§‘â€ğŸ’¼ ç®¡ç†è€…ç™ºè¡Œæšæ•°</div>
  <div class="count" id="adminIssued">--</div>
  <div class="sub">
    ä½¿ç”¨æ¸ˆã¿ï¼š<span id="adminUsed">--</span> ï¼
    æœªä½¿ç”¨ï¼š<span id="adminUnused">--</span>
  </div>
</div>

<!-- ä»£ç†ç™ºè¡Œ -->
<div class="card">
  <h3>ğŸ§‘â€ğŸ’¼ ä»£ç†ç™ºè¡Œ</h3>
  <button id="adminIssueBtn">ä»£ç†ã§é£Ÿåˆ¸ã‚’ç™ºè¡Œ</button>
  <p id="msg"></p>
  <div id="qr"></div>
</div>

<script type="module">
/* Firebase SDK */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  where,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase è¨­å®š */
const firebaseConfig = {
  apiKey: "AIzaSyALuZuT-PUJ8EGVQ0FfzZvN0c2lMujjqxw",
  authDomain: "ticket-system-acabc.firebaseapp.com",
  projectId: "ticket-system-acabc",
  storageBucket: "ticket-system-acabc.firebasestorage.app",
  messagingSenderId: "738817015202",
  appId: "1:738817015202:web:aa5c5b10c55f1069cec6fb"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* æ—¥æœ¬æ™‚é–“ */
function getJSTDate() {
  const now = new Date();
  const jst = new Date(now.getTime() + 9 * 60 * 60 * 1000);
  return jst.toISOString().slice(0, 10);
}

/* DOM */
const datePicker = document.getElementById("datePicker");
const msgEl = document.getElementById("msg");
const qrEl = document.getElementById("qr");

/* åˆæœŸæ—¥ä»˜ */
datePicker.value = getJSTDate();

/* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */
async function loadDashboard(date) {
  const colRef = collection(db, "tickets-" + date);

  const allSnap = await getDocs(colRef);
  const usedSnap = await getDocs(query(colRef, where("used", "==", true)));

  const adminAllSnap = await getDocs(
    query(colRef, where("adminIssued", "==", true))
  );
  const adminUsedSnap = await getDocs(
    query(colRef,
      where("adminIssued", "==", true),
      where("used", "==", true)
    )
  );

  const issued = allSnap.size;
  const used = usedSnap.size;

  const adminIssued = adminAllSnap.size;
  const adminUsed = adminUsedSnap.size;

  document.getElementById("issued").textContent = issued;
  document.getElementById("used").textContent = used;
  document.getElementById("unused").textContent = issued - used;

  document.getElementById("adminIssued").textContent = adminIssued;
  document.getElementById("adminUsed").textContent = adminUsed;
  document.getElementById("adminUnused").textContent =
    adminIssued - adminUsed;
}

/* è¡¨ç¤º */
document.getElementById("loadBtn").addEventListener("click", () => {
  loadDashboard(datePicker.value);
  qrEl.innerHTML = "";
  msgEl.textContent = "";
});

/* ä»£ç†ç™ºè¡Œ */
document.getElementById("adminIssueBtn").addEventListener("click", async () => {
  const date = datePicker.value;
  const colRef = collection(db, "tickets-" + date);

  try {
    const docRef = await addDoc(colRef, {
      used: false,
      adminIssued: true,
      created: serverTimestamp()
    });

    const ticketId = docRef.id;

    qrEl.innerHTML = "";
    QRCode.toCanvas(ticketId, { width: 250 }, (err, canvas) => {
      if (err) {
        msgEl.textContent = "QRç”Ÿæˆã‚¨ãƒ©ãƒ¼";
        return;
      }
      qrEl.appendChild(canvas);
    });

    msgEl.textContent = "ä»£ç†ç™ºè¡Œã—ã¾ã—ãŸï¼ˆå½“æ—¥æœ‰åŠ¹ï¼‰";
    loadDashboard(date);

  } catch (e) {
    msgEl.textContent = "ã‚¨ãƒ©ãƒ¼ï¼š" + e.message;
  }
});

/* åˆå› */
loadDashboard(datePicker.value);
</script>

</body>
</html>
